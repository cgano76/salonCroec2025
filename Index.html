<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CGANO – Quiz (Kiosk) + Admin</title>
  <style>
    :root{
      --brand1:#0070C0; --brand2:#0F3D73; --accent:#12b981;
      --bg:#f6f9ff; --card:#fff; --muted:#475569; --ink:#0f172a;
      --shadow:0 10px 30px rgba(11,35,70,.08); --radius:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;color:var(--ink);background:linear-gradient(180deg,var(--bg),#fff)}
    .container{max-width:980px;margin:28px auto;padding:18px}
    header{display:flex;align-items:center;gap:18px;background:linear-gradient(90deg,var(--brand1),var(--brand2));padding:18px;border-radius:16px;color:#fff;box-shadow:var(--shadow)}
    header img{height:64px;object-fit:contain;border-radius:6px;background:#fff;padding:6px}
    header .title{font-weight:800;font-size:20px}
    .card{background:var(--card);border-radius:14px;padding:18px;margin-top:18px;box-shadow:var(--shadow)}
    label{display:block;margin:8px 0;font-size:15px}
    input[type="text"],input[type="email"],input[type="tel"],input[type="password"]{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef7}
    .error{color:#b91c1c;font-size:12px;margin-top:4px;display:none}
    .qbox{min-height:140px;display:flex;flex-direction:column;justify-content:center}
    .opts{margin-top:8px;display:flex;flex-direction:column;gap:8px}
    .opts label{display:flex;gap:10px;align-items:center;padding:8px;border:1px solid #eef6ff;border-radius:10px}
    .controls{display:flex;gap:10px;justify-content:flex-end;margin-top:14px}
    button{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
    .primary{background:linear-gradient(90deg,var(--brand1),var(--brand2));color:#fff}
    .ghost{background:#eef3fb;color:var(--brand2)}
    .muted{color:#475569;font-size:13px}
    /* Barre de progression globale (coordonnées -> Q1..Q7 -> fin) */
    .progress{height:10px;background:#eef4ff;border-radius:10px;overflow:hidden;margin:12px 0 0}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--brand1),var(--brand2));width:0%;transition:width .25s ease}
    .hidden{display:none}
    .center{text-align:center}
    .topbar{display:flex;gap:10px;justify-content:flex-end;margin-top:8px}
    .tag{display:inline-flex;gap:8px;align-items:center;background:#ecfdf5;border:1px solid #d1fae5;color:#065f46;padding:6px 10px;border-radius:999px;font-size:12px}
    .admin-link{margin-left:auto}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #eef2f7;font-size:14px;text-align:left}
    th{background:#f5f8ff;position:sticky;top:0}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media(max-width:780px){ .grid{grid-template-columns:1fr} }
    @media print{ *{display:none !important} }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img src="CGA_logo-base line-CMJN.png" alt="Logo CGANO">
      <div>
        <div class="title">CGANO — Quiz interactif</div>
        <div class="muted">Salon régional de l’Ordre des Experts-Comptables</div>
      </div>
      <div class="admin-link">
        <button class="ghost" id="goAdmin">Espace admin</button>
      </div>
    </header>

    <!-- KIOSK -->
    <section id="kiosk" class="card">
      <!-- barre d’avancement globale -->
      <div class="progress" aria-hidden="true"><i id="globalBar" style="width:0%"></i></div>

      <form id="quizForm" onsubmit="return false;">
        <!-- IDENTITÉ -->
        <div id="step-person" class="step">
          <h3>Vos coordonnées (obligatoire)</h3>
          <div class="grid">
            <label>Nom <input type="text" name="nom" required></label>
            <label>Prénom <input type="text" name="prenom" required></label>
            <label>Cabinet <input type="text" name="cabinet" required></label>

            <label>Email
              <input type="email" name="email" required placeholder="ex : prenom.nom@cabinet.fr">
              <span class="error" id="emailErr">Format d’email invalide</span>
            </label>

            <label>Téléphone portable
              <input type="tel" name="tel" required placeholder="06 12 34 56 78">
              <span class="error" id="telErr">Entrez un mobile français valide (06 ou 07)</span>
            </label>
          </div>
          <div class="controls">
            <button class="primary" id="toQ">Commencer le quiz</button>
          </div>
        </div>

        <!-- QUESTIONS -->
        <div id="questions" class="hidden">
          <div class="qbox" data-q="1">
            <h3>1) Que signifie l’acronyme « CGA » pour le CGA Nord Ouest ?</h3>
            <div class="opts">
              <label><input type="radio" name="q1" value="A"> A) Conseiller – Accompagner – Garantir</label>
              <label><input type="radio" name="q1" value="B"> B) Comité de Gestion Administrative</label>
              <label><input type="radio" name="q1" value="C"> C) Conseil de Gestion Associative</label>
              <label><input type="radio" name="q1" value="D"> D) Chambre de Gestion Agricole</label>
            </div>
          </div>

          <div class="qbox hidden" data-q="2">
            <h3>2) Quelle est la mission principale d’un CGA auprès des TPE ?</h3>
            <div class="opts">
              <label><input type="radio" name="q2" value="A"> A) Tenir la comptabilité à la place du cabinet</label>
              <label><input type="radio" name="q2" value="B"> B) Assurer la prévention fiscale et accompagner les chefs d’entreprise</label>
              <label><input type="radio" name="q2" value="C"> C) Octroyer des crédits professionnels</label>
              <label><input type="radio" name="q2" value="D"> D) Fournir des assurances obligatoires</label>
            </div>
          </div>

          <div class="qbox hidden" data-q="3">
            <h3>3) Le CGANO propose un accès privilégié à une plateforme de formation en ligne. Laquelle ?</h3>
            <div class="opts">
              <label><input type="radio" name="q3" value="A"> A) ToutApprendre</label>
              <label><input type="radio" name="q3" value="B"> B) OpenClassrooms</label>
              <label><input type="radio" name="q3" value="C"> C) LinkedIn Learning</label>
            </div>
          </div>

          <div class="qbox hidden" data-q="4">
            <h3>4) Combien de points de contrôle comporte l’Examen de Conformité Fiscale (ECF) proposé par le CGANO ?</h3>
            <div class="opts">
              <label><input type="radio" name="q4" value="A"> A) 5</label>
              <label><input type="radio" name="q4" value="B"> B) 8</label>
              <label><input type="radio" name="q4" value="C"> C) 10</label>
              <label><input type="radio" name="q4" value="D"> D) 12</label>
            </div>
          </div>

          <div class="qbox hidden" data-q="5">
            <h3>5) En plus de ses missions fiscales, le CGANO propose à ses adhérents (plusieurs bonnes réponses possibles) :</h3>
            <div class="opts">
              <label><input type="checkbox" name="q5" value="A"> A) L’accès à des statistiques et observatoires économiques</label>
              <label><input type="checkbox" name="q5" value="B"> B) Des formations en présentiel et en e-learning</label>
              <label><input type="checkbox" name="q5" value="C"> C) L’accompagnement pour les aides publiques</label>
              <label><input type="checkbox" name="q5" value="D"> D) La gestion intégrale de la paie</label>
              <label><input type="checkbox" name="q5" value="E"> E) L’accès à une plateforme d’avantages professionnels et privés (ex : Dynabuy)</label>
            </div>
          </div>

          <div class="qbox hidden" data-q="6">
            <h3>6) Quelle innovation importante va concerner toutes les entreprises et sur laquelle le CGANO accompagne ses adhérents ?</h3>
            <div class="opts">
              <label><input type="radio" name="q6" value="A"> A) La facture électronique obligatoire</label>
              <label><input type="radio" name="q6" value="B"> B) Le prélèvement à la source des dividendes</label>
              <label><input type="radio" name="q6" value="C"> C) La suppression de la TVA</label>
              <label><input type="radio" name="q6" value="D"> D) Le paiement des salaires par cryptomonnaie</label>
            </div>
          </div>

          <div class="qbox hidden" data-q="7">
            <h3>7) Parmi ces services, lequel est également proposé par le CGANO ?</h3>
            <div class="opts">
              <label><input type="radio" name="q7" value="A"> A) Le bilan retraite personnalisé</label>
              <label><input type="radio" name="q7" value="B"> B) La vente de logiciels comptables</label>
              <label><input type="radio" name="q7" value="C"> C) Le financement direct des entreprises</label>
              <label><input type="radio" name="q7" value="D"> D) L’assurance habitation</label>
            </div>
          </div>

          <div class="controls">
            <button class="ghost" type="button" id="prevBtn" disabled>Précédent</button>
            <button class="primary" type="button" id="nextBtn">Suivant</button>
          </div>
        </div>

        <!-- FIN -->
        <div id="end" class="hidden">
          <div class="result">
            <h3 class="center">Merci pour votre participation !</h3>
            <p class="center"><strong id="finalScore"></strong></p>
            <p class="center">Nous vous tiendrons informé·e par email si vous êtes <strong>vainqueur du tirage au sort</strong> 🎉</p>
            <p class="muted center" id="emailInfo"></p>
          </div>
          <div class="controls" style="justify-content:center">
            <button class="primary" id="restartBtn" type="button">Revenir à l’écran d’accueil</button>
          </div>
        </div>
      </form>
    </section>

    <!-- ADMIN -->
    <section id="admin" class="card hidden">
      <h2>Espace admin</h2>
      <div id="adminLogin">
        <p>Entrer le <strong>code admin</strong> :</p>
        <div class="grid">
          <label>Code <input type="password" id="adminCode" placeholder="ex : 27600"></label>
        </div>
        <div class="controls">
          <button class="primary" id="adminEnter">Se connecter</button>
          <button class="ghost" id="adminBack">Retour au quiz</button>
        </div>
        <p class="muted">Code par défaut : <code>CGANO2025</code> (modifiable après connexion).</p>
      </div>

      <div id="adminPanel" class="hidden">
        <div class="grid">
          <label>Recherche (nom, cabinet, email) <input type="text" id="search"></label>
          <label>Nouveau code admin <input type="password" id="newPin" placeholder="laisser vide pour ne pas changer"></label>
        </div>
        <div class="controls" style="justify-content:flex-start">
          <button class="primary" id="exportCsv">Exporter CSV</button>
          <button class="ghost" id="applyPin">Mettre à jour le code</button>
          <button class="ghost" id="clearAll">Tout effacer</button>
          <button class="ghost" id="backToQuiz">Retour au quiz</button>
        </div>
        <div style="max-height:420px;overflow:auto;margin-top:12px">
          <table id="tbl">
            <thead>
              <tr>
                <th>#</th><th>Date/heure</th><th>Nom</th><th>Prénom</th><th>Cabinet</th><th>Email</th><th>Téléphone</th><th>Score</th><th>Q1..Q7</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <script>
    /* ====== CONFIG ====== */
    const CORRECT = { q1:["A"], q2:["B"], q3:["A"], q4:["C"], q5:["A","B","C","E"], q6:["A"], q7:["A"] };
    const TOTAL = 7;                              // questions
    const STEPS_TOTAL = TOTAL + 2;                // coordonnées + questions + fin
    const STORAGE_KEY = "cgano_quiz_responses_v1";
    const PIN_KEY = "cgano_quiz_admin_pin";
    const DEFAULT_PIN = "CGANO2025";

    /* ====== UTILS ====== */
    const $ = sel => document.querySelector(sel);
    const $all = sel => Array.from(document.querySelectorAll(sel));
    function nowISO(){ return new Date().toISOString().slice(0,19).replace('T',' '); }
    function getStore(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }catch{ return []; } }
    function setStore(arr){ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }
    function getPin(){ return localStorage.getItem(PIN_KEY) || DEFAULT_PIN; }
    function setPin(v){ localStorage.setItem(PIN_KEY, v); }

    // Validation email / téléphone (FR mobile 06/07 + séparateurs)
    const emailRe = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i;
    const telRe = /^(?:\+33|0)\s*[67](?:[\s.\-]?\d{2}){4}$/;

    // Avancement global (0..STEPS_TOTAL-1)
    function setProgress(stepIndex){
      const pct = Math.round((stepIndex/(STEPS_TOTAL-1))*100);
      $("#globalBar").style.width = pct + "%";
    }

    /* ====== KIOSK FLOW ====== */
    const form = $("#quizForm");
    const stepPerson = $("#step-person");
    const questions = $("#questions");
    const endView = $("#end");
    const prevBtn = $("#prevBtn");
    const nextBtn = $("#nextBtn");
    let current = 0; // écran coordonnées = 0
    setProgress(0);

    // Validation live
    form.email.addEventListener("input", ()=>{
      const ok = emailRe.test(form.email.value.trim());
      $("#emailErr").style.display = ok ? "none" : "block";
    });
    form.tel.addEventListener("input", ()=>{
      const ok = telRe.test(form.tel.value.trim());
      $("#telErr").style.display = ok ? "none" : "block";
    });

    $("#toQ").addEventListener("click", () => {
      const need = ["nom","prenom","cabinet","email","tel"];
      for(const n of need){ if(!form[n].value.trim()){ alert("Merci de remplir toutes les coordonnées."); return; } }
      if(!emailRe.test(form.email.value.trim())){
        $("#emailErr").style.display = "block"; form.email.focus(); return;
      }
      if(!telRe.test(form.tel.value.trim())){
        $("#telErr").style.display = "block"; form.tel.focus(); return;
      }
      stepPerson.classList.add("hidden");
      questions.classList.remove("hidden");
      current = 1; // question 1
      showQ(current);
      setProgress(1); // on passe à l’étape 1/… (Q1)
    });

    function showQ(n){
      $all(".qbox").forEach(x=>x.classList.add("hidden"));
      const el = document.querySelector(`.qbox[data-q="${n}"]`);
      if(el) el.classList.remove("hidden");
      prevBtn.disabled = (n===1);
      nextBtn.textContent = (n===TOTAL? "Terminer":"Suivant");
      setProgress(n); // 1..7
    }

    prevBtn.addEventListener("click", ()=>{ if(current>1){ current--; showQ(current);} });

    nextBtn.addEventListener("click", ()=>{
      const qbox = document.querySelector(`.qbox[data-q="${current}"]`);
      const has = qbox ? Array.from(qbox.querySelectorAll('input')).some(i=>i.checked) : true;
      if(!has && !confirm("Vous n'avez sélectionné aucune réponse pour cette question. Continuer ?")) return;
      if(current < TOTAL){ current++; showQ(current); }
      else finish(); // aller à l’écran final
    });

    function answersOf(){
      const data = {};
      for(let i=1;i<=TOTAL;i++){
        const name = "q"+i;
        const inputs = $all(`[name="${name}"]`);
        if(!inputs.length){ data[name]=[]; continue; }
        if(inputs[0].type === "checkbox"){
          data[name] = inputs.filter(x=>x.checked).map(x=>x.value);
        } else {
          const sel = inputs.find(x=>x.checked);
          data[name] = sel ? [sel.value] : [];
        }
      }
      return data;
    }

    function scoreOf(ans){
      let s=0;
      for(const k in CORRECT){
        const a = (ans[k]||[]).slice().sort().join(',');
        const c = CORRECT[k].slice().sort().join(',');
        if(a===c) s++;
      }
      return s;
    }

    function finish(){
      const ans = answersOf();
      const score = scoreOf(ans);
      questions.classList.add("hidden");
      endView.classList.remove("hidden");
      $("#finalScore").textContent = `Votre score : ${score} / ${TOTAL}`;
      setProgress(TOTAL+1); // écran final

      // Enregistre local
      const row = {
        ts: nowISO(),
        nom: form.nom.value.trim(),
        prenom: form.prenom.value.trim(),
        cabinet: form.cabinet.value.trim(),
        email: form.email.value.trim(),
        tel: form.tel.value.trim(),
        score, answers: ans
      };
      const arr = getStore(); arr.push(row); setStore(arr);

      // Prépare/enclenche l’email via mailto:
      const mail = encodeURIComponent(row.email);
      const subject = encodeURIComponent("Votre participation au quiz CGANO");
      const body = encodeURIComponent(
        `Bonjour ${row.prenom} ${row.nom},\n\n`+
        `Merci pour votre participation au quiz CGANO lors du salon régional.`+
        `\nVotre score : ${score}/${TOTAL}.`+
        `\n\nNous vous tiendrons informé·e par email si vous êtes vainqueur du tirage au sort.\n\n`+
        `Bien cordialement,\nL’équipe CGANO`
      );
      const href = `mailto:${mail}?subject=${subject}&body=${body}`;

      // Tentative d’ouverture automatique (certains navigateurs peuvent la bloquer)
      const a = document.createElement("a");
      a.href = href;
      a.style.display = "none";
      document.body.appendChild(a);
      setTimeout(()=>{ a.click(); document.body.removeChild(a); }, 100);

      // Affiche un lien au cas où l’ouverture serait bloquée
      $("#emailInfo").innerHTML = `Un email de confirmation va être généré à l’adresse <strong>${row.email}</strong>.<br>
        Si aucun client mail ne s’ouvre, <a href="${href}">cliquez ici pour envoyer l’email</a>.`;

      window.scrollTo({top:0,behavior:"smooth"});
    }

    $("#restartBtn").addEventListener("click", ()=>{
      for(let i=1;i<=TOTAL;i++){ $all(`[name="q${i}"]`).forEach(i=> i.checked=false); }
      endView.classList.add("hidden"); questions.classList.add("hidden");
      stepPerson.classList.remove("hidden");
      setProgress(0);
      current = 0;
    });

    // Bloque Ctrl/Cmd + P
    window.addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='p'){ e.preventDefault(); } });

    /* ====== ADMIN (inchangé) ====== */
    const kiosk = $("#kiosk");
    const admin = $("#admin");
    const adminLogin = $("#adminLogin");
    const adminPanel = $("#adminPanel");
    const goAdmin = $("#goAdmin");
    const adminEnter = $("#adminEnter");
    const adminBack = $("#adminBack");
    const backToQuiz = $("#backToQuiz");
    const exportCsv = $("#exportCsv");
    const clearAll = $("#clearAll");
    const applyPin = $("#applyPin");
    const search = $("#search");
    const tblBody = $("#tbl tbody");

    goAdmin.addEventListener("click", ()=>{ kiosk.classList.add("hidden"); admin.classList.remove("hidden"); adminLogin.classList.remove("hidden"); adminPanel.classList.add("hidden"); $("#adminCode").value=""; });
    adminBack.addEventListener("click", ()=>{ admin.classList.add("hidden"); kiosk.classList.remove("hidden"); });
    backToQuiz.addEventListener("click", ()=>{ admin.classList.add("hidden"); kiosk.classList.remove("hidden"); });

    function getPin(){ return localStorage.getItem(PIN_KEY) || DEFAULT_PIN; }
    function setPin(v){ localStorage.setItem(PIN_KEY, v); }

    adminEnter.addEventListener("click", ()=>{
      const code = $("#adminCode").value;
      if(code === getPin()){
        adminLogin.classList.add("hidden"); adminPanel.classList.remove("hidden");
        renderTable();
      } else alert("Code incorrect");
    });

    function renderTable(){
      const q = search.value.trim().toLowerCase();
      const rows = getStore().map((r,idx)=>({...r, idx: idx+1})).filter(r=>{
        const hay = (r.nom+" "+r.prenom+" "+r.cabinet+" "+r.email).toLowerCase();
        return hay.includes(q);
      });
      tblBody.innerHTML = rows.map(r=>{
        const qjoin = [r.answers.q1,r.answers.q2,r.answers.q3,r.answers.q4,r.answers.q5,r.answers.q6,r.answers.q7]
          .map(x=>(x||[]).join("|")).join(" / ");
        return `<tr>
          <td>${r.idx}</td><td>${r.ts}</td><td>${r.nom}</td><td>${r.prenom}</td>
          <td>${r.cabinet}</td><td>${r.email}</td><td>${r.tel}</td><td>${r.score}/${TOTAL}</td><td>${qjoin}</td>
        </tr>`;
      }).join("");
    }
    search.addEventListener("input", renderTable);

    exportCsv.addEventListener("click", ()=>{
      const rows = getStore();
      const headers = ["Timestamp","Nom","Prénom","Cabinet","Email","Téléphone","Score","Q1","Q2","Q3","Q4","Q5","Q6","Q7"];
      const esc = v => { const s = String(v ?? "").replace(/"/g,'""'); return /[",\n\r]/.test(s) ? `"${s}"` : s; };
      const toCSV = (rows)=>[headers.join(",")].concat(rows.map(r=>[
        r.ts,r.nom,r.prenom,r.cabinet,r.email,r.tel,r.score,
        (r.answers.q1||[]).join("|"),
        (r.answers.q2||[]).join("|"),
        (r.answers.q3||[]).join("|"),
        (r.answers.q4||[]).join("|"),
        (r.answers.q5||[]).join("|"),
        (r.answers.q6||[]).join("|"),
        (r.answers.q7||[]).join("|")
      ].map(esc).join(","))).join("\n");
      const csv = toCSV(rows);
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "quiz_responses.csv";
      document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 1500);
    });

    clearAll.addEventListener("click", ()=>{
      if(confirm("Supprimer toutes les réponses stockées sur cet appareil ?")){ setStore([]); renderTable(); }
    });

    applyPin.addEventListener("click", ()=>{
      const v = $("#newPin").value.trim();
      if(!v){ alert("Laisser vide ne change pas le code."); return; }
      setPin(v); $("#newPin").value=""; alert("Code admin mis à jour.");
    });
  </script>
</body>
</html>